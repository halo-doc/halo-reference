<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Protection Against Exploits :: Spring</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Spring</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Why Spring</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Reactive</a>
            <a class="navbar-item" href="#">Event Driven</a>
            <a class="navbar-item" href="#">Cloud</a>
            <a class="navbar-item" href="#">Web Applications</a>
            <a class="navbar-item" href="#">Serverless</a>
            <a class="navbar-item" href="#">Batch</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Learn</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Quickstart</a>
            <a class="navbar-item" href="#">Guides</a>
            <a class="navbar-item" href="#">Blog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Spring Boot</a>
            <a class="navbar-item" href="#">...</a>
          </div>
        </div>

        <a class="navbar-item" href="#">Training</a>
        <a class="navbar-item" href="#">Support</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Events</a>
            <a class="navbar-item" href="#">Team</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="security" data-version="5.6.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../overview/prerequisites.html">Spring Security</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/prerequisites.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/community.html">Community</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/whats-new.html">What&#8217;s New</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/getting-spring-security.html">Getting Spring Security</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/modules.html">Project Modules &amp; Dependencies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../overview/samples.html">Samples</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Servlet Applications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hello/index.html">Hello Spring Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture/index.html">Servet Security: The Big Picture</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Spring Security</span>
    <span class="version">5.6.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../framework/5.3.8/index.html">Spring Framework</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../framework/5.3.8/index.html">5.3.8</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../overview/prerequisites.html">Spring Security</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../overview/prerequisites.html">5.6.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../framework/5.3.8/overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../overview/prerequisites.html">Spring Security</a></li>
    <li><a href="index.html">Protection Against Exploits</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rwinch/spring-security/edit/antora-2.x/docs/modules/ROOT/pages/servlet/exploits/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Protection Against Exploits</h1>
<div class="sect1">
<h2 id="servlet-csrf"><a class="anchor" href="#servlet-csrf"></a>Cross Site Request Forgery (CSRF) for Servlet Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section discusses Spring Security&#8217;s <a href="#csrf">Cross Site Request Forgery (CSRF)</a> support for servlet environments.</p>
</div>
<div class="sect2">
<h3 id="servlet-csrf-using"><a class="anchor" href="#servlet-csrf-using"></a>Using Spring Security CSRF Protection</h3>
<div class="paragraph">
<p>The steps to using Spring Security&#8217;s CSRF protection are outlined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#servlet-csrf-idempotent">Use proper HTTP verbs</a></p>
</li>
<li>
<p><a href="#servlet-csrf-configure">Configure CSRF Protection</a></p>
</li>
<li>
<p><a href="#servlet-csrf-include">Include the CSRF Token</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="servlet-csrf-idempotent"><a class="anchor" href="#servlet-csrf-idempotent"></a>Use proper HTTP verbs</h4>
<div class="paragraph">
<p>The first step to protecting against CSRF attacks is to ensure your website uses proper HTTP verbs.
This is covered in detail in <a href="#csrf-protection-idempotent">Safe Methods Must be Idempotent</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="servlet-csrf-configure"><a class="anchor" href="#servlet-csrf-configure"></a>Configure CSRF Protection</h4>
<div class="paragraph">
<p>The next step is to configure Spring Security&#8217;s CSRF protection within your application.
Spring Security&#8217;s CSRF protection is enabled by default, but you may need to customize the configuration.
Below are a few common customizations.</p>
</div>
<div class="sect4">
<h5 id="servlet-csrf-configure-custom-repository"><a class="anchor" href="#servlet-csrf-configure-custom-repository"></a>Custom CsrfTokenRepository</h5>
<div class="paragraph">
<p>By default Spring Security stores the expected CSRF token in the <code>HttpSession</code> using <code>HttpSessionCsrfTokenRepository</code>.
There can be cases where users will want to configure a custom <code>CsrfTokenRepository</code>.
For example, it might be desirable to persist the <code>CsrfToken</code> in a cookie to <a href="#servlet-csrf-include-ajax-auto">support a JavaScript based application</a>.</p>
</div>
<div class="paragraph">
<p>By default the <code>CookieCsrfTokenRepository</code> will write to a cookie named <code>XSRF-TOKEN</code> and read it from a header named <code>X-XSRF-TOKEN</code> or the HTTP parameter <code>_csrf</code>.
These defaults come from <a href="https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection">AngularJS</a></p>
</div>
<div class="paragraph">
<p>You can configure <code>CookieCsrfTokenRepository</code> in XML using the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Store CSRF Token in a Cookie with XML Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;
	&lt;csrf token-repository-ref="tokenRepository"/&gt;
&lt;/http&gt;
&lt;b:bean id="tokenRepository"
	class="org.springframework.security.web.csrf.CookieCsrfTokenRepository"
	p:cookieHttpOnly="false"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The sample explicitly sets <code>cookieHttpOnly=false</code>.
This is necessary to allow JavaScript (i.e. AngularJS) to read it.
If you do not need the ability to read the cookie with JavaScript directly, it is recommended to omit <code>cookieHttpOnly=false</code> to improve security.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure <code>CookieCsrfTokenRepository</code> in Java Configuration using:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Store CSRF Token in a Cookie</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			.csrf(csrf -&gt; csrf
				.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
       http {
            csrf {
                csrfTokenRepository = CookieCsrfTokenRepository.withHttpOnlyFalse()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The sample explicitly sets <code>cookieHttpOnly=false</code>.
This is necessary to allow JavaScript (i.e. AngularJS) to read it.
If you do not need the ability to read the cookie with JavaScript directly, it is recommended to omit <code>cookieHttpOnly=false</code> (by using <code>new CookieCsrfTokenRepository()</code> instead) to improve security.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="servlet-csrf-configure-disable"><a class="anchor" href="#servlet-csrf-configure-disable"></a>Disable CSRF Protection</h5>
<div class="paragraph">
<p>CSRF protection is enabled by default.
However, it is simple to disable CSRF protection if it <a href="#csrf-when">makes sense for your application</a>.</p>
</div>
<div class="paragraph">
<p>The XML configuration below will disable CSRF protection.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Disable CSRF XML Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;
	&lt;csrf disabled="true"/&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The Java configuration below will disable CSRF protection.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Disable CSRF</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			.csrf(csrf -&gt; csrf.disable());
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Configuration
@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
       http {
            csrf {
                disable()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet-csrf-include"><a class="anchor" href="#servlet-csrf-include"></a>Include the CSRF Token</h4>
<div class="paragraph">
<p>In order for the <a href="#csrf-protection-stp">synchronizer token pattern</a> to protect against CSRF attacks, we must include the actual CSRF token in the HTTP request.
This must be included in a part of the request (i.e. form parameter, HTTP header, etc) that is not automatically included in the HTTP request by the browser.</p>
</div>
<div class="paragraph">
<p>Spring Security&#8217;s <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/csrf/CsrfFilter.html">CsrfFilter</a> exposes a <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/csrf/CsrfToken.html">CsrfToken</a> as an <code>HttpServletRequest</code> attribute named <code>_csrf</code>.
This means that any view technology can access the <code>CsrfToken</code> to expose the expected token as either a <a href="#servlet-csrf-include-form-attr">form</a> or <a href="#servlet-csrf-include-ajax-meta-attr">meta tag</a>.
Fortunately, there are integrations listed below that make including the token in <a href="#servlet-csrf-include-form">form</a> and <a href="#servlet-csrf-include-ajax">ajax</a> requests even easier.</p>
</div>
<div class="sect4">
<h5 id="servlet-csrf-include-form"><a class="anchor" href="#servlet-csrf-include-form"></a>Form URL Encoded</h5>
<div class="paragraph">
<p>In order to post an HTML form the CSRF token must be included in the form as a hidden input.
For example, the rendered HTML might look like:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. CSRF Token HTML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;input type="hidden"
	name="_csrf"
	value="4bfd1575-3ad1-4d21-96c7-4ef2d9f86721"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we will discuss various ways of including the CSRF token in a form as a hidden input.</p>
</div>
<div class="sect5">
<h6 id="servlet-csrf-include-form-auto"><a class="anchor" href="#servlet-csrf-include-form-auto"></a>Automatic CSRF Token Inclusion</h6>
<div class="paragraph">
<p>Spring Security&#8217;s CSRF support provides integration with Spring&#8217;s <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/support/RequestDataValueProcessor.html">RequestDataValueProcessor</a> via its <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/servlet/support/csrf/CsrfRequestDataValueProcessor.html">CsrfRequestDataValueProcessor</a>.
This means that if you leverage <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-view-jsp-formtaglib">Spring’s form tag library</a>, <a href="https://www.thymeleaf.org/doc/tutorials/2.1/thymeleafspring.html#integration-with-requestdatavalueprocessor">Thymeleaf</a>, or any other view technology that integrates with <code>RequestDataValueProcessor</code>, then forms that have an unsafe HTTP method (i.e. post) will automatically include the actual CSRF token.</p>
</div>
</div>
<div class="sect5">
<h6 id="servlet-csrf-include-form-tag"><a class="anchor" href="#servlet-csrf-include-form-tag"></a>csrfInput Tag</h6>
<div class="paragraph">
<p>If you are using JSPs, then you can use <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-view-jsp-formtaglib">Spring’s form tag library</a>.
However, if that is not an option, you can also easily include the token with the <a href="#taglibs-csrfinput">csrfInput</a> tag.</p>
</div>
</div>
<div class="sect5">
<h6 id="servlet-csrf-include-form-attr"><a class="anchor" href="#servlet-csrf-include-form-attr"></a>CsrfToken Request Attribute</h6>
<div class="paragraph">
<p>If the <a href="#servlet-csrf-include">other options</a> for including the actual CSRF token in the request do not work, you can take advantage of the fact that the <code>CsrfToken</code> <a href="#servlet-csrf-include">is exposed</a> as an <code>HttpServletRequest</code> attribute named <code>_csrf</code>.</p>
</div>
<div class="paragraph">
<p>An example of doing this with a JSP is shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. CSRF Token in Form with Request Attribute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;c:url var="logoutUrl" value="/logout"/&gt;
&lt;form action="${logoutUrl}"
	method="post"&gt;
&lt;input type="submit"
	value="Log out" /&gt;
&lt;input type="hidden"
	name="${_csrf.parameterName}"
	value="${_csrf.token}"/&gt;
&lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="servlet-csrf-include-ajax"><a class="anchor" href="#servlet-csrf-include-ajax"></a>Ajax and JSON Requests</h5>
<div class="paragraph">
<p>If you are using JSON, then it is not possible to submit the CSRF token within an HTTP parameter.
Instead you can submit the token within a HTTP header.</p>
</div>
<div class="paragraph">
<p>In the following sections we will discuss various ways of including the CSRF token as an HTTP request header in JavaScript based applications.</p>
</div>
<div class="sect5">
<h6 id="servlet-csrf-include-ajax-auto"><a class="anchor" href="#servlet-csrf-include-ajax-auto"></a>Automatic Inclusion</h6>
<div class="paragraph">
<p>Spring Security can easily be <a href="#servlet-csrf-configure-custom-repository">configured</a> to store the expected CSRF token in a cookie.
By storing the expected CSRF in a cookie, JavaScript frameworks like <a href="https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection">AngularJS</a> will automatically include the actual CSRF token in the HTTP request headers.</p>
</div>
</div>
<div class="sect5">
<h6 id="servlet-csrf-include-ajax-meta"><a class="anchor" href="#servlet-csrf-include-ajax-meta"></a>Meta tags</h6>
<div class="paragraph">
<p>An alternative pattern to <a href="#servlet-csrf-include-form-auto">exposing the CSRF in a cookie</a> is to include the CSRF token within your <code>meta</code> tags.
The HTML might look something like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. CSRF meta tag HTML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;html&gt;
&lt;head&gt;
	&lt;meta name="_csrf" content="4bfd1575-3ad1-4d21-96c7-4ef2d9f86721"/&gt;
	&lt;meta name="_csrf_header" content="X-CSRF-TOKEN"/&gt;
	&lt;!-- ... --&gt;
&lt;/head&gt;
&lt;!-- ... --&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the meta tags contained the CSRF token, the JavaScript code would read the meta tags and include the CSRF token as a header.
If you were using jQuery, this could be done with the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. AJAX send CSRF Token</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">$(function () {
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	$(document).ajaxSend(function(e, xhr, options) {
		xhr.setRequestHeader(header, token);
	});
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect6">
<h7 id="servlet-csrf-include-ajax-meta-tag"><a class="anchor" href="#servlet-csrf-include-ajax-meta-tag"></a>csrfMeta tag</h7>
<div class="paragraph">
<p>If you are using JSPs a simple way to write the CSRF token to the <code>meta</code> tags is by leveraging the <a href="#taglibs-csrfmeta">csrfMeta</a> tag.</p>
</div>
</div>
<div class="sect6">
<h7 id="servlet-csrf-include-ajax-meta-attr"><a class="anchor" href="#servlet-csrf-include-ajax-meta-attr"></a>CsrfToken Request Attribute</h7>
<div class="paragraph">
<p>If the <a href="#servlet-csrf-include">other options</a> for including the actual CSRF token in the request do not work, you can take advantage of the fact that the <code>CsrfToken</code> <a href="#servlet-csrf-include">is exposed</a> as an <code>HttpServletRequest</code> attribute named <code>_csrf</code>.
An example of doing this with a JSP is shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. CSRF meta tag JSP</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;html&gt;
&lt;head&gt;
	&lt;meta name="_csrf" content="${_csrf.token}"/&gt;
	&lt;!-- default header name is X-CSRF-TOKEN --&gt;
	&lt;meta name="_csrf_header" content="${_csrf.headerName}"/&gt;
	&lt;!-- ... --&gt;
&lt;/head&gt;
&lt;!-- ... --&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-csrf-considerations"><a class="anchor" href="#servlet-csrf-considerations"></a>CSRF Considerations</h3>
<div class="paragraph">
<p>There are a few special considerations to consider when implementing protection against CSRF attacks.
This section discusses those considerations as it pertains to servlet environments.
Refer to <a href="#csrf-considerations">[csrf-considerations]</a> for a more general discussion.</p>
</div>
<div class="sect3">
<h4 id="servlet-considerations-csrf-login"><a class="anchor" href="#servlet-considerations-csrf-login"></a>Logging In</h4>
<div class="paragraph">
<p>It is important to <a href="#csrf-considerations-login">require CSRF for log in</a> requests to protect against forging log in attempts.
Spring Security&#8217;s servlet support does this out of the box.</p>
</div>
</div>
<div class="sect3">
<h4 id="servlet-considerations-csrf-logout"><a class="anchor" href="#servlet-considerations-csrf-logout"></a>Logging Out</h4>
<div class="paragraph">
<p>It is important to <a href="#csrf-considerations-logout">require CSRF for log out</a> requests to protect against forging log out attempts.
If CSRF protection is enabled (default), Spring Security&#8217;s <code>LogoutFilter</code> to only process HTTP POST.
This ensures that log out requires a CSRF token and that a malicious user cannot forcibly log out your users.</p>
</div>
<div class="paragraph">
<p>The easiest approach is to use a form to log out.
If you really want a link, you can use JavaScript to have the link perform a POST (i.e. maybe on a hidden form).
For browsers with JavaScript that is disabled, you can optionally have the link take the user to a log out confirmation page that will perform the POST.</p>
</div>
<div class="paragraph">
<p>If you really want to use HTTP GET with logout you can do so, but remember this is generally not recommended.
For example, the following Java Configuration will perform logout with the URL <code>/logout</code> is requested with any HTTP method:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Log out with HTTP GET</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			.logout(logout -&gt; logout
				.logoutRequestMatcher(new AntPathRequestMatcher("/logout"))
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
       http {
            logout {
                logoutRequestMatcher = AntPathRequestMatcher("/logout")
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet-considerations-csrf-timeouts"><a class="anchor" href="#servlet-considerations-csrf-timeouts"></a>CSRF and Session Timeouts</h4>
<div class="paragraph">
<p>By default Spring Security stores the CSRF token in the <code>HttpSession</code>.
This can lead to a situation where the session expires which means there is not an expected CSRF token to validate against.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already discussed <a href="#csrf-considerations-login">general solutions</a> to session timeouts.
This section discusses the specifics of CSRF timeouts as it pertains to the servlet support.</p>
</div>
<div class="paragraph">
<p>It is simple to change storage of the expected CSRF token to be in a cookie.
For details, refer to the <a href="#servlet-csrf-configure-custom-repository">Custom CsrfTokenRepository</a> section.</p>
</div>
<div class="paragraph">
<p>If a token does expire, you might want to customize how it is handled by specifying a custom <code>AccessDeniedHandler</code>.
The custom <code>AccessDeniedHandler</code> can process the <code>InvalidCsrfTokenException</code> any way you like.
For an example of how to customize the <code>AccessDeniedHandler</code> refer to the provided links for both <a href="#nsa-access-denied-handler">xml</a> and <a href="https://github.com/spring-projects/spring-security/blob/3.2.0.RC1/config/src/test/java/org/springframework/security/config/annotation/web/configurers/NamespaceHttpAccessDeniedHandlerTests.java#L64">Java configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="servlet-csrf-considerations-multipart"><a class="anchor" href="#servlet-csrf-considerations-multipart"></a>Multipart (file upload)</h4>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart">already discussed</a> how protecting multipart requests (file uploads) from CSRF attacks causes a <a href="https://en.wikipedia.org/wiki/Chicken_or_the_egg">chicken and the egg</a> problem.
This section discusses how to implement placing the CSRF token in the <a href="#servlet-csrf-considerations-multipart-body">body</a> and <a href="#servlet-csrf-considerations-multipart-url">url</a> within a servlet application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>More information about using multipart forms with Spring can be found within the <a href="https://docs.spring.io/spring/docs/5.2.x/spring-framework-reference/web.html#mvc-multipart">1.1.11. Multipart Resolver</a> section of the Spring reference and the <a href="https://docs.spring.io/spring/docs/5.2.x/javadoc-api/org/springframework/web/multipart/support/MultipartFilter.html">MultipartFilter javadoc</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="servlet-csrf-considerations-multipart-body"><a class="anchor" href="#servlet-csrf-considerations-multipart-body"></a>Place CSRF Token in the Body</h5>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart-body">already discussed</a> the tradeoffs of placing the CSRF token in the body.
In this section we will discuss how to configure Spring Security to read the CSRF from the body.</p>
</div>
<div class="paragraph">
<p>In order to read the CSRF token from the body, the <code>MultipartFilter</code> is specified before the Spring Security filter.
Specifying the <code>MultipartFilter</code> before the Spring Security filter means that there is no authorization for invoking the <code>MultipartFilter</code> which means anyone can place temporary files on your server.
However, only authorized users will be able to submit a File that is processed by your application.
In general, this is the recommended approach because the temporary file upload should have a negligible impact on most servers.</p>
</div>
<div class="paragraph">
<p>To ensure <code>MultipartFilter</code> is specified before the Spring Security filter with java configuration, users can override beforeSpringSecurityFilterChain as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Initializer MultipartFilter</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SecurityApplicationInitializer extends AbstractSecurityWebApplicationInitializer {

	@Override
	protected void beforeSpringSecurityFilterChain(ServletContext servletContext) {
		insertFilters(servletContext, new MultipartFilter());
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">class SecurityApplicationInitializer : AbstractSecurityWebApplicationInitializer() {
    override fun beforeSpringSecurityFilterChain(servletContext: ServletContext?) {
        insertFilters(servletContext, MultipartFilter())
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To ensure <code>MultipartFilter</code> is specified before the Spring Security filter with XML configuration, users can ensure the &lt;filter-mapping&gt; element of the <code>MultipartFilter</code> is placed before the springSecurityFilterChain within the web.xml as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. web.xml - MultipartFilter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;filter&gt;
	&lt;filter-name&gt;MultipartFilter&lt;/filter-name&gt;
	&lt;filter-class&gt;org.springframework.web.multipart.support.MultipartFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter&gt;
	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
	&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
	&lt;filter-name&gt;MultipartFilter&lt;/filter-name&gt;
	&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
&lt;filter-mapping&gt;
	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
	&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="servlet-csrf-considerations-multipart-url"><a class="anchor" href="#servlet-csrf-considerations-multipart-url"></a>Include CSRF Token in URL</h5>
<div class="paragraph">
<p>If allowing unauthorized users to upload temporary files is not acceptable, an alternative is to place the <code>MultipartFilter</code> after the Spring Security filter and include the CSRF as a query parameter in the action attribute of the form.
Since the <code>CsrfToken</code> is exposed as an <code>HttpServletRequest</code> <a href="#servlet-csrf-include">request attribute</a>, we can use that to create an <code>action</code> with the CSRF token in it.
An example with a jsp is shown below</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. CSRF Token in Action</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;form method="post"
	action="./upload?${_csrf.parameterName}=${_csrf.token}"
	enctype="multipart/form-data"&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet-csrf-considerations-override-method"><a class="anchor" href="#servlet-csrf-considerations-override-method"></a>HiddenHttpMethodFilter</h4>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart-body">already discussed</a> the trade-offs of placing the CSRF token in the body.</p>
</div>
<div class="paragraph">
<p>In Spring&#8217;s Servlet support, overriding the HTTP method is done using <a href="https://docs.spring.io/spring-framework/docs/5.2.x/javadoc-api/org/springframework/web/filter/reactive/HiddenHttpMethodFilter.html">HiddenHttpMethodFilter</a>.
More information can be found in <a href="https://docs.spring.io/spring/docs/5.2.x/spring-framework-reference/web.html#mvc-rest-method-conversion">HTTP Method Conversion</a> section of the reference documentation.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="servlet-headers"><a class="anchor" href="#servlet-headers"></a>Security HTTP Response Headers</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#headers">Security HTTP Response Headers</a> can be used to increase the security of web applications.
This section is dedicated to servlet based support for Security HTTP Response Headers.</p>
</div>
<div class="sect2">
<h3 id="servlet-headers-default"><a class="anchor" href="#servlet-headers-default"></a>Default Security Headers</h3>
<div class="paragraph">
<p>Spring Security provides a <a href="#headers-default">default set of Security HTTP Response Headers</a> to provide secure defaults.
While each of these headers are considered best practice, it should be noted that not all clients utilize the headers, so additional testing is encouraged.</p>
</div>
<div class="paragraph">
<p>You can customize specific headers.
For example, assume that you want the defaults except you wish to specify <code>SAMEORIGIN</code> for <a href="#servlet-headers-frame-options">X-Frame-Options</a>.</p>
</div>
<div class="paragraph">
<p>You can easily do this with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Customize Default Security Headers</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.headers(headers -&gt; headers
				.frameOptions(frameOptions -&gt; frameOptions
					.sameOrigin()
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;frame-options policy="SAMEORIGIN" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {
    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                frameOptions {
                    sameOrigin = true
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you do not want the defaults to be added and want explicit control over what should be used, you can disable the defaults.
An example is provided below:</p>
</div>
<div class="paragraph">
<p>If you are using Spring Security&#8217;s Configuration the following will only add <a href="#headers-cache-control">Cache Control</a>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Customize Cache Control Headers</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				// do not use any default headers unless explicitly listed
				.defaultsDisabled()
				.cacheControl(withDefaults())
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers defaults-disabled="true"&gt;
		&lt;cache-control/&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {
    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                // do not use any default headers unless explicitly listed
                defaultsDisabled = true
                cacheControl {
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If necessary, you can disable all of the HTTP Security response headers with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Disable All HTTP Security Headers</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers.disable());
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers disabled="true" /&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {
    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                disable()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-cache-control"><a class="anchor" href="#servlet-headers-cache-control"></a>Cache Control</h3>
<div class="paragraph">
<p>Spring Security includes <a href="#headers-cache-control">Cache Control</a> headers by default.</p>
</div>
<div class="paragraph">
<p>However, if you actually want to cache specific responses, your application can selectively invoke <a href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletResponse.html#setHeader(java.lang.String,java.lang.String)">HttpServletResponse.setHeader(String,String)</a> to override the header set by Spring Security.
This is useful to ensure things like CSS, JavaScript, and images are properly cached.</p>
</div>
<div class="paragraph">
<p>When using Spring Web MVC, this is typically done within your configuration.
Details on how to do this can be found in the <a href="https://docs.spring.io/spring/docs/5.0.0.RELEASE/spring-framework-reference/web.html#mvc-config-static-resources">Static Resources</a> portion of the Spring Reference documentation</p>
</div>
<div class="paragraph">
<p>If necessary, you can also disable Spring Security&#8217;s cache control HTTP response headers.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Cache Control Disabled</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.headers(headers -&gt; headers
				.cacheControl(cache -&gt; cache.disable())
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;cache-control disabled="true"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
       http {
            headers {
                cacheControl {
                    disable()
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-content-type-options"><a class="anchor" href="#servlet-headers-content-type-options"></a>Content Type Options</h3>
<div class="paragraph">
<p>Spring Security includes <a href="#headers-content-type-options">Content-Type</a> headers by default.
However, you can disable it with:</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Content Type Options Disabled</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.headers(headers -&gt; headers
				.contentTypeOptions(contentTypeOptions -&gt; contentTypeOptions.disable())
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;content-type-options disabled="true"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
       http {
            headers {
                contentTypeOptions {
                    disable()
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-hsts"><a class="anchor" href="#servlet-headers-hsts"></a>HTTP Strict Transport Security (HSTS)</h3>
<div class="paragraph">
<p>Spring Security provides the <a href="#headers-hsts">Strict Transport Security</a> header by default.
However, you can customize the results explicitly.
For example, the following is an example of explicitly providing HSTS:</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Strict Transport Security</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.httpStrictTransportSecurity(hsts -&gt; hsts
					.includeSubDomains(true)
					.preload(true)
					.maxAgeInSeconds(31536000)
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;hsts
			include-subdomains="true"
			max-age-seconds="31536000"
			preload="true" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            headers {
                httpStrictTransportSecurity {
                    includeSubDomains = true
                    preload = true
                    maxAgeInSeconds = 31536000
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-hpkp"><a class="anchor" href="#servlet-headers-hpkp"></a>HTTP Public Key Pinning (HPKP)</h3>
<div class="paragraph">
<p>For passivity reasons, Spring Security provides servlet support for <a href="#headers-hpkp">HTTP Public Key Pinning</a> but it is <a href="#headers-hpkp-deprecated">no longer recommended</a>.</p>
</div>
<div class="paragraph">
<p>You can enable HPKP headers with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. HTTP Public Key Pinning</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.httpPublicKeyPinning(hpkp -&gt; hpkp
					.includeSubDomains(true)
					.reportUri("https://example.net/pkp-report")
					.addSha256Pins("d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=", "E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=")
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;hpkp
			include-subdomains="true"
			report-uri="https://example.net/pkp-report"&gt;
			&lt;pins&gt;
				&lt;pin algorithm="sha256"&gt;d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=&lt;/pin&gt;
				&lt;pin algorithm="sha256"&gt;E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=&lt;/pin&gt;
			&lt;/pins&gt;
		&lt;/hpkp&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            headers {
                httpPublicKeyPinning {
                    includeSubDomains = true
                    reportUri = "https://example.net/pkp-report"
                    pins = mapOf("d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=" to "sha256",
                            "E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=" to "sha256")
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-frame-options"><a class="anchor" href="#servlet-headers-frame-options"></a>X-Frame-Options</h3>
<div class="paragraph">
<p>By default, Spring Security disables rendering within an iframe using <a href="#headers-frame-options">X-Frame-Options</a>.</p>
</div>
<div class="paragraph">
<p>You can customize frame options to use the same origin within a Configuration using the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. X-Frame-Options: SAMEORIGIN</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.frameOptions(frameOptions -&gt; frameOptions
					.sameOrigin()
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;frame-options
		policy="SAMEORIGIN" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            headers {
                frameOptions {
                    sameOrigin = true
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-xss-protection"><a class="anchor" href="#servlet-headers-xss-protection"></a>X-XSS-Protection</h3>
<div class="paragraph">
<p>By default, Spring Security instructs browsers to block reflected XSS attacks using the &lt;&lt;headers-xss-protection,X-XSS-Protection header&gt;.
However, you can change this default.
For example, the following Configuration specifies that Spring Security should no longer instruct browsers to block the content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. X-XSS-Protection Customization</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.xssProtection(xss -&gt; xss
					.block(false)
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;xss-protection block="false"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        // ...
        http {
            headers {
                xssProtection {
                    block = false
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-csp"><a class="anchor" href="#servlet-headers-csp"></a>Content Security Policy (CSP)</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-csp">Content Security Policy</a> by default, because a reasonable default is impossible to know without context of the application.
The web application author must declare the security policy(s) to enforce and/or monitor for the protected resources.</p>
</div>
<div class="paragraph">
<p>For example, given the following security policy:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Content Security Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-http hljs" data-lang="http">Content-Security-Policy: script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can enable the CSP header as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Content Security Policy</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.headers(headers -&gt; headers
				.contentSecurityPolicy(csp -&gt; csp
					.policyDirectives("script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/")
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;content-security-policy
			policy-directives="script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                contentSecurityPolicy {
                    policyDirectives = "script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To enable the CSP <code>report-only</code> header, provide the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Content Security Policy Report Only</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.contentSecurityPolicy(csp -&gt; csp
					.policyDirectives("script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/")
					.reportOnly()
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;content-security-policy
			policy-directives="script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"
			report-only="true" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                contentSecurityPolicy {
                    policyDirectives = "script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"
                    reportOnly = true
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-referrer"><a class="anchor" href="#servlet-headers-referrer"></a>Referrer Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-referrer">Referrer Policy</a> headers by default.
You can enable the Referrer Policy header using the configuration as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Referrer Policy</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.headers(headers -&gt; headers
				.referrerPolicy(referrer -&gt; referrer
					.policy(ReferrerPolicy.SAME_ORIGIN)
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;referrer-policy policy="same-origin" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                referrerPolicy {
                    policy = ReferrerPolicy.SAME_ORIGIN
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-feature"><a class="anchor" href="#servlet-headers-feature"></a>Feature Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-feature">Feature Policy</a> headers by default.
The following <code>Feature-Policy</code> header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Feature-Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Feature-Policy: geolocation 'self'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>can enable the Feature Policy header using the configuration shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Feature-Policy</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.featurePolicy("geolocation 'self'")
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;feature-policy policy-directives="geolocation 'self'" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                featurePolicy("geolocation 'self'")
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-permissions"><a class="anchor" href="#servlet-headers-permissions"></a>Permissions Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-permissions">Permissions Policy</a> headers by default.
The following <code>Permissions-Policy</code> header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Permissions-Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Permissions-Policy: geolocation=(self)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>can enable the Permissions Policy header using the configuration shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Permissions-Policy</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.permissionsPolicy(permissions -&gt; permissions
					.policy("geolocation=(self)")
				)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;permissions-policy policy="geolocation=(self)" /&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                permissionPolicy {
                    policy = "geolocation=(self)"
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-clear-site-data"><a class="anchor" href="#servlet-headers-clear-site-data"></a>Clear Site Data</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-clear-site-data">Clear-Site-Data</a> headers by default.
The following Clear-Site-Data header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Clear-Site-Data Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Clear-Site-Data: "cache", "cookies"</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>can be sent on log out with the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Clear-Site-Data</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.logout()
				.addLogoutHandler(new HeaderWriterLogoutHandler(new ClearSiteDataHeaderWriter(CACHE, COOKIES)));
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            logout {
                addLogoutHandler(HeaderWriterLogoutHandler(ClearSiteDataHeaderWriter(CACHE, COOKIES)))
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-headers-custom"><a class="anchor" href="#servlet-headers-custom"></a>Custom Headers</h3>
<div class="paragraph">
<p>Spring Security has mechanisms to make it convenient to add the more common security headers to your application.
However, it also provides hooks to enable adding custom headers.</p>
</div>
<div class="sect3">
<h4 id="servlet-headers-static"><a class="anchor" href="#servlet-headers-static"></a>Static Headers</h4>
<div class="paragraph">
<p>There may be times you wish to inject custom security headers into your application that are not supported out of the box.
For example, given the following custom security header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>X-Custom-Security-Header: header-value</code></pre>
</div>
</div>
<div class="paragraph">
<p>The headers could be added to the response using the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. StaticHeadersWriter</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.addHeaderWriter(new StaticHeadersWriter("X-Custom-Security-Header","header-value"))
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;header name="X-Custom-Security-Header" value="header-value"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                addHeaderWriter(StaticHeadersWriter("X-Custom-Security-Header","header-value"))
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet-headers-writer"><a class="anchor" href="#servlet-headers-writer"></a>Headers Writer</h4>
<div class="paragraph">
<p>When the namespace or Java configuration does not support the headers you want, you can create a custom <code>HeadersWriter</code> instance or even provide a custom implementation of the <code>HeadersWriter</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at an example of using an custom instance of <code>XFrameOptionsHeaderWriter</code>.
If you wanted to explicitly configure <a href="#servlet-headers-frame-options">X-Frame-Options</a> it could be done with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Headers Writer</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			// ...
			.headers(headers -&gt; headers
				.addHeaderWriter(new XFrameOptionsHeaderWriter(XFrameOptionsMode.SAMEORIGIN))
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;header ref="frameOptionsWriter"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;
&lt;!-- Requires the c-namespace.
See https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#beans-c-namespace
--&gt;
&lt;beans:bean id="frameOptionsWriter"
	class="org.springframework.security.web.header.writers.frameoptions.XFrameOptionsHeaderWriter"
	c:frameOptionsMode="SAMEORIGIN"/&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            headers {
                addHeaderWriter(XFrameOptionsHeaderWriter(XFrameOptionsMode.SAMEORIGIN))
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="headers-delegatingrequestmatcherheaderwriter"><a class="anchor" href="#headers-delegatingrequestmatcherheaderwriter"></a>DelegatingRequestMatcherHeaderWriter</h4>
<div class="paragraph">
<p>At times you may want to only write a header for certain requests.
For example, perhaps you want to only protect your log in page from being framed.
You could use the <code>DelegatingRequestMatcherHeaderWriter</code> to do so.</p>
</div>
<div class="paragraph">
<p>An example of using <code>DelegatingRequestMatcherHeaderWriter</code> in Java Configuration can be seen below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. DelegatingRequestMatcherHeaderWriter Java Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@EnableWebSecurity
public class WebSecurityConfig extends
WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		RequestMatcher matcher = new AntPathRequestMatcher("/login");
		DelegatingRequestMatcherHeaderWriter headerWriter =
			new DelegatingRequestMatcherHeaderWriter(matcher,new XFrameOptionsHeaderWriter());
		http
			// ...
			.headers(headers -&gt; headers
				.frameOptions(frameOptions -&gt; frameOptions.disable())
				.addHeaderWriter(headerWriter)
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;!-- ... --&gt;

	&lt;headers&gt;
		&lt;frame-options disabled="true"/&gt;
		&lt;header ref="headerWriter"/&gt;
	&lt;/headers&gt;
&lt;/http&gt;

&lt;beans:bean id="headerWriter"
	class="org.springframework.security.web.header.writers.DelegatingRequestMatcherHeaderWriter"&gt;
	&lt;beans:constructor-arg&gt;
		&lt;bean class="org.springframework.security.web.util.matcher.AntPathRequestMatcher"
			c:pattern="/login"/&gt;
	&lt;/beans:constructor-arg&gt;
	&lt;beans:constructor-arg&gt;
		&lt;beans:bean
			class="org.springframework.security.web.header.writers.frameoptions.XFrameOptionsHeaderWriter"/&gt;
	&lt;/beans:constructor-arg&gt;
&lt;/beans:bean&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        val matcher: RequestMatcher = AntPathRequestMatcher("/login")
        val headerWriter = DelegatingRequestMatcherHeaderWriter(matcher, XFrameOptionsHeaderWriter())
       http {
            headers {
                frameOptions {
                    disable()
                }
                addHeaderWriter(headerWriter)
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="servlet-http"><a class="anchor" href="#servlet-http"></a>HTTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All HTTP based communication should be protected <a href="#http">using TLS</a>.</p>
</div>
<div class="paragraph">
<p>Below you can find details around Servlet specific features that assist with HTTPS usage.</p>
</div>
<div class="sect2">
<h3 id="servlet-http-redirect"><a class="anchor" href="#servlet-http-redirect"></a>Redirect to HTTPS</h3>
<div class="paragraph">
<p>If a client makes a request using HTTP rather than HTTPS, Spring Security can be configured to redirect to HTTPS.</p>
</div>
<div class="paragraph">
<p>For example, the following Java configuration will redirect any HTTP requests to HTTPS:</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. Redirect to HTTPS</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends
		WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) {
		http
			// ...
			.requiresChannel(channel -&gt; channel
				.anyRequest().requiresSecure()
			);
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Configuration
@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {

    override fun configure(http: HttpSecurity) {
        http {
            // ...
            requiresChannel {
                secure(AnyRequestMatcher.INSTANCE, "REQUIRES_SECURE_CHANNEL")
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following XML configuration will redirect all HTTP requests to HTTPS</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Redirect to HTTPS with XML Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;http&gt;
	&lt;intercept-url pattern="/**" access="ROLE_USER" requires-channel="https"/&gt;
...
&lt;/http&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="servlet-hsts"><a class="anchor" href="#servlet-hsts"></a>Strict Transport Security</h3>
<div class="paragraph">
<p>Spring Security provides support for <a href="#servlet-headers-hsts">Strict Transport Security</a> and enables it by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="servlet-http-proxy-server"><a class="anchor" href="#servlet-http-proxy-server"></a>Proxy Server Configuration</h3>
<div class="paragraph">
<p>Spring Security <a href="#http-proxy-server">integrates with proxy servers</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="servlet-httpfirewall"><a class="anchor" href="#servlet-httpfirewall"></a>HttpFirewall</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Security has several areas where patterns you have defined are tested against incoming requests in order to decide how the request should be handled.
This occurs when the <code>FilterChainProxy</code> decides which filter chain a request should be passed through and also when the <code>FilterSecurityInterceptor</code> decides which security constraints apply to a request.
It&#8217;s important to understand what the mechanism is and what URL value is used when testing against the patterns that you define.</p>
</div>
<div class="paragraph">
<p>The Servlet Specification defines several properties for the <code>HttpServletRequest</code> which are accessible via getter methods, and which we might want to match against.
These are the <code>contextPath</code>, <code>servletPath</code>, <code>pathInfo</code> and <code>queryString</code>.
Spring Security is only interested in securing paths within the application, so the <code>contextPath</code> is ignored.
Unfortunately, the servlet spec does not define exactly what the values of <code>servletPath</code> and <code>pathInfo</code> will contain for a particular request URI.
For example, each path segment of a URL may contain parameters, as defined in <a href="https://www.ietf.org/rfc/rfc2396.txt">RFC 2396</a>
<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.
The Specification does not clearly state whether these should be included in the <code>servletPath</code> and <code>pathInfo</code> values and the behaviour varies between different servlet containers.
There is a danger that when an application is deployed in a container which does not strip path parameters from these values, an attacker could add them to the requested URL in order to cause a pattern match to succeed or fail unexpectedly.
<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.
Other variations in the incoming URL are also possible.
For example, it could contain path-traversal sequences (like <code>/../</code>) or multiple forward slashes (<code>//</code>) which could also cause pattern-matches to fail.
Some containers normalize these out before performing the servlet mapping, but others don&#8217;t.
To protect against issues like these, <code>FilterChainProxy</code> uses an <code>HttpFirewall</code> strategy to check and wrap the request.
Un-normalized requests are automatically rejected by default, and path parameters and duplicate slashes are removed for matching purposes.
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>.
It is therefore essential that a <code>FilterChainProxy</code> is used to manage the security filter chain.
Note that the <code>servletPath</code> and <code>pathInfo</code> values are decoded by the container, so your application should not have any valid paths which contain semi-colons, as these parts will be removed for matching purposes.</p>
</div>
<div class="paragraph">
<p>As mentioned above, the default strategy is to use Ant-style paths for matching and this is likely to be the best choice for most users.
The strategy is implemented in the class <code>AntPathRequestMatcher</code> which uses Spring&#8217;s <code>AntPathMatcher</code> to perform a case-insensitive match of the pattern against the concatenated <code>servletPath</code> and <code>pathInfo</code>, ignoring the <code>queryString</code>.</p>
</div>
<div class="paragraph">
<p>If for some reason, you need a more powerful matching strategy, you can use regular expressions.
The strategy implementation is then <code>RegexRequestMatcher</code>.
See the Javadoc for this class for more information.</p>
</div>
<div class="paragraph">
<p>In practice we recommend that you use method security at your service layer, to control access to your application, and do not rely entirely on the use of security constraints defined at the web-application level.
URLs change and it is difficult to take account of all the possible URLs that an application might support and how requests might be manipulated.
You should try and restrict yourself to using a few simple ant paths which are simple to understand.
Always try to use a "deny-by-default" approach where you have a catch-all wildcard ( /<strong> or </strong>) defined last and denying access.</p>
</div>
<div class="paragraph">
<p>Security defined at the service layer is much more robust and harder to bypass, so you should always take advantage of Spring Security&#8217;s method security options.</p>
</div>
<div class="paragraph">
<p>The <code>HttpFirewall</code> also prevents <a href="https://www.owasp.org/index.php/HTTP_Response_Splitting">HTTP Response Splitting</a> by rejecting new line characters in the HTTP Response headers.</p>
</div>
<div class="paragraph">
<p>By default the <code>StrictHttpFirewall</code> is used.
This implementation rejects requests that appear to be malicious.
If it is too strict for your needs, then you can customize what types of requests are rejected.
However, it is important that you do so knowing that this can open your application up to attacks.
For example, if you wish to leverage Spring MVC&#8217;s Matrix Variables, the following configuration could be used:</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Allow Matrix Variables</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StrictHttpFirewall httpFirewall() {
    StrictHttpFirewall firewall = new StrictHttpFirewall();
    firewall.setAllowSemicolon(true);
    return firewall;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;b:bean id="httpFirewall"
    class="org.springframework.security.web.firewall.StrictHttpFirewall"
    p:allowSemicolon="true"/&gt;

&lt;http-firewall ref="httpFirewall"/&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun httpFirewall(): StrictHttpFirewall {
    val firewall = StrictHttpFirewall()
    firewall.setAllowSemicolon(true)
    return firewall
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>StrictHttpFirewall</code> provides an allowed list of valid HTTP methods that are allowed to protect against <a href="https://www.owasp.org/index.php/Cross_Site_Tracing">Cross Site Tracing (XST)</a> and <a href="https://www.owasp.org/index.php/Test_HTTP_Methods_(OTG-CONFIG-006)">HTTP Verb Tampering</a>.
The default valid methods are "DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", and "PUT".
If your application needs to modify the valid methods, you can configure a custom <code>StrictHttpFirewall</code> bean.
For example, the following will only allow HTTP "GET" and "POST" methods:</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. Allow Only GET &amp; POST</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StrictHttpFirewall httpFirewall() {
    StrictHttpFirewall firewall = new StrictHttpFirewall();
    firewall.setAllowedHttpMethods(Arrays.asList("GET", "POST"));
    return firewall;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;b:bean id="httpFirewall"
      class="org.springframework.security.web.firewall.StrictHttpFirewall"
      p:allowedHttpMethods="GET,HEAD"/&gt;

&lt;http-firewall ref="httpFirewall"/&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun httpFirewall(): StrictHttpFirewall {
    val firewall = StrictHttpFirewall()
    firewall.setAllowedHttpMethods(listOf("GET", "POST"))
    return firewall
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using <code>new MockHttpServletRequest()</code> it currently creates an HTTP method as an empty String "".
This is an invalid HTTP method and will be rejected by Spring Security.
You can resolve this by replacing it with <code>new MockHttpServletRequest("GET", "")</code>.
See <a href="https://jira.spring.io/browse/SPR-16851">SPR_16851</a> for an issue requesting to improve this.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you must allow any HTTP method (not recommended), you can use <code>StrictHttpFirewall.setUnsafeAllowAnyHttpMethod(true)</code>.
This will disable validation of the HTTP method entirely.</p>
</div>
<div id="servlet-httpfirewall-headers-parameters" class="paragraph">
<p><code>StrictHttpFirewall</code> also checks header names and values and parameter names.
It requires that each character have a defined code point and not be a control character.</p>
</div>
<div class="paragraph">
<p>This requirement can be relaxed or adjusted as necessary using the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StrictHttpFirewall#setAllowedHeaderNames(Predicate)</code></p>
</li>
<li>
<p><code>StrictHttpFirewall#setAllowedHeaderValues(Predicate)</code></p>
</li>
<li>
<p><code>StrictHttpFirewall#setAllowedParameterNames(Predicate)</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Also, parameter values can be controlled with <code>setAllowedParameterValues(Predicate)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, to switch off this check, you can wire your <code>StrictHttpFirewall</code> with <code>Predicate</code> s that always return <code>true</code>, like so:</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. Allow Any Header Name, Header Value, and Parameter Name</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StrictHttpFirewall httpFirewall() {
    StrictHttpFirewall firewall = new StrictHttpFirewall();
    firewall.setAllowedHeaderNames((header) -&gt; true);
    firewall.setAllowedHeaderValues((header) -&gt; true);
    firewall.setAllowedParameterNames((parameter) -&gt; true);
    return firewall;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun httpFirewall(): StrictHttpFirewall {
    val firewall = StrictHttpFirewall()
    firewall.setAllowedHeaderNames { true }
    firewall.setAllowedHeaderValues { true }
    firewall.setAllowedParameterNames { true }
    return firewall
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Or, there might be a specific value that you need to allow.</p>
</div>
<div class="paragraph">
<p>For example, iPhone Xʀ uses a <code>User-Agent</code> that includes a character not in the ISO-8859-1 charset.
Due to this fact, some application servers will parse this value into two separate characters, the latter being an undefined character.</p>
</div>
<div class="paragraph">
<p>You can address this with the <code>setAllowedHeaderValues</code> method, as you can see below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. Allow Certain User Agents</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public StrictHttpFirewall httpFirewall() {
    StrictHttpFirewall firewall = new StrictHttpFirewall();
    Pattern allowed = Pattern.compile("[\\p{IsAssigned}&amp;&amp;[^\\p{IsControl}]]*");
    Pattern userAgent = ...;
    firewall.setAllowedHeaderValues((header) -&gt; allowed.matcher(header).matches() || userAgent.matcher(header).matches());
    return firewall;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun httpFirewall(): StrictHttpFirewall {
    val firewall = StrictHttpFirewall()
    val allowed = Pattern.compile("[\\p{IsAssigned}&amp;&amp;[^\\p{IsControl}]]*")
    val userAgent = Pattern.compile(...)
    firewall.setAllowedHeaderValues { allowed.matcher(it).matches() || userAgent.matcher(it).matches() }
    return firewall
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the case of header values, you may instead consider parsing them as UTF-8 at verification time like so:</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. Parse Headers As UTF-8</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">firewall.setAllowedHeaderValues((header) -&gt; {
    String parsed = new String(header.getBytes(ISO_8859_1), UTF_8);
    return allowed.matcher(parsed).matches();
});</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">firewall.setAllowedHeaderValues {
    val parsed = String(header.getBytes(ISO_8859_1), UTF_8)
    return allowed.matcher(parsed).matches()
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. You have probably seen this when a browser doesn&#8217;t support cookies and the <code>jsessionid</code> parameter is appended to the URL after a semi-colon. However the RFC allows the presence of these parameters in any path segment of the URL
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The original values will be returned once the request leaves the <code>FilterChainProxy</code>, so will still be available to the application.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. So, for example, an original request path <code>/secure;hack=1/somefile.html;hack=2</code> will be returned as <code>/secure/somefile.html</code>.
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
