<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Protection Against Exploits :: Spring</title>
    <meta name="generator" content="Antora 3.0.0-alpha.6">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/docsearch.min.css">
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css -->    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Spring</a>
      <div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Why Spring</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Reactive</a>
            <a class="navbar-item" href="#">Event Driven</a>
            <a class="navbar-item" href="#">Cloud</a>
            <a class="navbar-item" href="#">Web Applications</a>
            <a class="navbar-item" href="#">Serverless</a>
            <a class="navbar-item" href="#">Batch</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Learn</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Quickstart</a>
            <a class="navbar-item" href="#">Guides</a>
            <a class="navbar-item" href="#">Blog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Spring Boot</a>
            <a class="navbar-item" href="#">...</a>
          </div>
        </div>

        <a class="navbar-item" href="#">Training</a>
        <a class="navbar-item" href="#">Support</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Overview</a>
            <a class="navbar-item" href="#">Events</a>
            <a class="navbar-item" href="#">Team</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="security" data-version="5.6">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../overview/index.html">Spring Security</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Overview</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/prerequisites.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/community.html">Community</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/whats-new.html">What&#8217;s New</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/getting-spring-security.html">Getting Spring Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../overview/features/index.html">Features</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../overview/features/authentication/index.html">Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../overview/features/exploits/index.html">Protection Against Exploits</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/modules.html">Project Modules &amp; Dependencies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/samples.html">Samples</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Servlet Applications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../servlet/hello/index.html">Hello Spring Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../servlet/architecture/index.html">The Big Picture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Authentication</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/architecture/index.html">Authentication Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../servlet/authentication/unpwd/index.html">Username/Password</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reading Username/Password</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/form.html">Form</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/basic.html">Basic</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/digest.html">Digest</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Password Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/in-memory.html">In Memory</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/jdbc.html">JDBC</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/user-details.html">UserDetails</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/user-details-service.html">UserDetailsService</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/password-encoder.html">PasswordEncoder</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/dao-authentication-provider.html">DaoAuthenticationProvider</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../servlet/authentication/unpwd/ldap.html">LDAP</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/session-management.html">Session Management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/rememberme.html">Remember Me</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/openid.html">OpenID</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/anonymous.html">Anonymous</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/preauth.html">Pre-Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/jaas.html">JAAS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/cas.html">CAS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/x509.html">X509</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/runas.html">Run-As</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/logout.html">Logout</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authentication/events.html">Authentication Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Authorization</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/architecture.html">Authorization Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/authorize-requests.html">Authorize HTTP Requests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/expression-based.html">Expression-Based Access Control</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/secure-objects.html">Secure Object Implementations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/method-security.html">Method Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/authorization/acls.html">Domain Object Security ACLs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">OAuth2</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/oauth2/oauth2-login.html">OAuth2 Log In</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/oauth2/oauth2-client.html">OAuth2 Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../servlet/oauth2/oauth2-resourceserver.html">OAuth2 Resource Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../servlet/saml2/index.html">SAML2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore" style="display: none;">
  <div class="context">
    <span class="title">Spring Security</span>
    <span class="version">5.6</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../framework/5.3/index.html">Spring Framework</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../framework/5.3/index.html">5.3</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../6/overview/prerequisites.html">Spring Security</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../6/overview/prerequisites.html">6</a>
        </li>
        <li class="version is-current">
          <a href="../../overview/index.html">5.6</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="" role="navigation">
<button class="nav-toggle"></button>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Protection Against Exploits</h1>
<div class="sect1">
<h2 id="webflux-csrf"><a class="anchor" href="#webflux-csrf"></a>Cross Site Request Forgery (CSRF) for WebFlux Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section discusses Spring Security&#8217;s <a href="#csrf">Cross Site Request Forgery (CSRF)</a> support for WebFlux environments.</p>
</div>
<div class="sect2">
<h3 id="webflux-csrf-using"><a class="anchor" href="#webflux-csrf-using"></a>Using Spring Security CSRF Protection</h3>
<div class="paragraph">
<p>The steps to using Spring Security&#8217;s CSRF protection are outlined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#webflux-csrf-idempotent">Use proper HTTP verbs</a></p>
</li>
<li>
<p><a href="#webflux-csrf-configure">Configure CSRF Protection</a></p>
</li>
<li>
<p><a href="#webflux-csrf-include">Include the CSRF Token</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="webflux-csrf-idempotent"><a class="anchor" href="#webflux-csrf-idempotent"></a>Use proper HTTP verbs</h4>
<div class="paragraph">
<p>The first step to protecting against CSRF attacks is to ensure your website uses proper HTTP verbs.
This is covered in detail in <a href="#csrf-protection-idempotent">Safe Methods Must be Idempotent</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="webflux-csrf-configure"><a class="anchor" href="#webflux-csrf-configure"></a>Configure CSRF Protection</h4>
<div class="paragraph">
<p>The next step is to configure Spring Security&#8217;s CSRF protection within your application.
Spring Security&#8217;s CSRF protection is enabled by default, but you may need to customize the configuration.
Below are a few common customizations.</p>
</div>
<div class="sect4">
<h5 id="webflux-csrf-configure-custom-repository"><a class="anchor" href="#webflux-csrf-configure-custom-repository"></a>Custom CsrfTokenRepository</h5>
<div class="paragraph">
<p>By default Spring Security stores the expected CSRF token in the <code>WebSession</code> using <code>WebSessionServerCsrfTokenRepository</code>.
There can be cases where users will want to configure a custom <code>ServerCsrfTokenRepository</code>.
For example, it might be desirable to persist the <code>CsrfToken</code> in a cookie to <a href="#webflux-csrf-include-ajax-auto">support a JavaScript based application</a>.</p>
</div>
<div class="paragraph">
<p>By default the <code>CookieServerCsrfTokenRepository</code> will write to a cookie named <code>XSRF-TOKEN</code> and read it from a header named <code>X-XSRF-TOKEN</code> or the HTTP parameter <code>_csrf</code>.
These defaults come from <a href="https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection">AngularJS</a></p>
</div>
<div class="paragraph">
<p>You can configure <code>CookieServerCsrfTokenRepository</code> in Java Configuration using:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Store CSRF Token in a Cookie</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.csrf(csrf -&gt; csrf.csrfTokenRepository(CookieServerCsrfTokenRepository.withHttpOnlyFalse()))
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        csrf {
            csrfTokenRepository = CookieServerCsrfTokenRepository.withHttpOnlyFalse()
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The sample explicitly sets <code>cookieHttpOnly=false</code>.
This is necessary to allow JavaScript (i.e. AngularJS) to read it.
If you do not need the ability to read the cookie with JavaScript directly, it is recommended to omit <code>cookieHttpOnly=false</code> (by using <code>new CookieServerCsrfTokenRepository()</code> instead) to improve security.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="webflux-csrf-configure-disable"><a class="anchor" href="#webflux-csrf-configure-disable"></a>Disable CSRF Protection</h5>
<div class="paragraph">
<p>CSRF protection is enabled by default.
However, it is simple to disable CSRF protection if it <a href="#csrf-when">makes sense for your application</a>.</p>
</div>
<div class="paragraph">
<p>The Java configuration below will disable CSRF protection.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Disable CSRF Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.csrf(csrf -&gt; csrf.disable()))
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        csrf {
            disable()
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="webflux-csrf-include"><a class="anchor" href="#webflux-csrf-include"></a>Include the CSRF Token</h4>
<div class="paragraph">
<p>In order for the <a href="#csrf-protection-stp">synchronizer token pattern</a> to protect against CSRF attacks, we must include the actual CSRF token in the HTTP request.
This must be included in a part of the request (i.e. form parameter, HTTP header, etc) that is not automatically included in the HTTP request by the browser.</p>
</div>
<div class="paragraph">
<p>Spring Security&#8217;s <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/server/csrf/CsrfWebFilter.html">CsrfWebFilter</a> exposes a <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/csrf/CsrfToken.html">Mono&lt;CsrfToken&gt;</a> as a <code>ServerWebExchange</code> attribute named <code>org.springframework.security.web.server.csrf.CsrfToken</code>.
This means that any view technology can access the <code>Mono&lt;CsrfToken&gt;</code> to expose the expected token as either a <a href="#webflux-csrf-include-form-attr">form</a> or <a href="#webflux-csrf-include-ajax-meta">meta tag</a>.</p>
</div>
<div id="webflux-csrf-include-subscribe" class="paragraph">
<p>If your view technology does not provide a simple way to subscribe to the <code>Mono&lt;CsrfToken&gt;</code>, a common pattern is to use Spring&#8217;s <code>@ControllerAdvice</code> to expose the <code>CsrfToken</code> directly.
For example, the following code will place the <code>CsrfToken</code> on the default attribute name (<code>_csrf</code>) used by Spring Security&#8217;s <a href="#webflux-csrf-include-form-auto">CsrfRequestDataValueProcessor</a> to automatically include the CSRF token as a hidden input.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. <code>CsrfToken</code> as <code>@ModelAttribute</code></div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ControllerAdvice
public class SecurityControllerAdvice {
	@ModelAttribute
	Mono&lt;CsrfToken&gt; csrfToken(ServerWebExchange exchange) {
		Mono&lt;CsrfToken&gt; csrfToken = exchange.getAttribute(CsrfToken.class.getName());
		return csrfToken.doOnSuccess(token -&gt; exchange.getAttributes()
				.put(CsrfRequestDataValueProcessor.DEFAULT_CSRF_ATTR_NAME, token));
	}
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@ControllerAdvice
class SecurityControllerAdvice {
    @ModelAttribute
    fun csrfToken(exchange: ServerWebExchange): Mono&lt;CsrfToken&gt; {
        val csrfToken: Mono&lt;CsrfToken&gt;? = exchange.getAttribute(CsrfToken::class.java.name)
        return csrfToken!!.doOnSuccess { token -&gt;
            exchange.attributes[CsrfRequestDataValueProcessor.DEFAULT_CSRF_ATTR_NAME] = token
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Fortunately, Thymeleaf provides <a href="#webflux-csrf-include-form-auto">integration</a> that works without any additional work.</p>
</div>
<div class="sect4">
<h5 id="webflux-csrf-include-form"><a class="anchor" href="#webflux-csrf-include-form"></a>Form URL Encoded</h5>
<div class="paragraph">
<p>In order to post an HTML form the CSRF token must be included in the form as a hidden input.
For example, the rendered HTML might look like:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. CSRF Token HTML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;input type="hidden"
	name="_csrf"
	value="4bfd1575-3ad1-4d21-96c7-4ef2d9f86721"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we will discuss various ways of including the CSRF token in a form as a hidden input.</p>
</div>
<div class="sect5">
<h6 id="webflux-csrf-include-form-auto"><a class="anchor" href="#webflux-csrf-include-form-auto"></a>Automatic CSRF Token Inclusion</h6>
<div class="paragraph">
<p>Spring Security&#8217;s CSRF support provides integration with Spring&#8217;s <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/reactive/result/view/RequestDataValueProcessor.html">RequestDataValueProcessor</a> via its <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/reactive/result/view/CsrfRequestDataValueProcessor.html">CsrfRequestDataValueProcessor</a>.
In order for <code>CsrfRequestDataValueProcessor</code> to work, the <code>Mono&lt;CsrfToken&gt;</code> must be subscribed to and the <code>CsrfToken</code> must be <a href="#webflux-csrf-include-subscribe">exposed as an attribute</a> that matches <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/reactive/result/view/CsrfRequestDataValueProcessor.html#DEFAULT_CSRF_ATTR_NAME">DEFAULT_CSRF_ATTR_NAME</a>.</p>
</div>
<div class="paragraph">
<p>Fortunately, Thymeleaf <a href="https://www.thymeleaf.org/doc/tutorials/2.1/thymeleafspring.html#integration-with-requestdatavalueprocessor">provides support</a> to take care of all the boilerplate for you by integrating with <code>RequestDataValueProcessor</code> to ensure that forms that have an unsafe HTTP method (i.e. post) will automatically include the actual CSRF token.</p>
</div>
</div>
<div class="sect5">
<h6 id="webflux-csrf-include-form-attr"><a class="anchor" href="#webflux-csrf-include-form-attr"></a>CsrfToken Request Attribute</h6>
<div class="paragraph">
<p>If the <a href="#webflux-csrf-include">other options</a> for including the actual CSRF token in the request do not work, you can take advantage of the fact that the <code>Mono&lt;CsrfToken&gt;</code> <a href="#webflux-csrf-include">is exposed</a> as a <code>ServerWebExchange</code> attribute named <code>org.springframework.security.web.server.csrf.CsrfToken</code>.</p>
</div>
<div class="paragraph">
<p>The Thymeleaf sample below assumes that you <a href="#webflux-csrf-include-subscribe">expose</a> the <code>CsrfToken</code> on an attribute named <code>_csrf</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. CSRF Token in Form with Request Attribute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;form th:action="@{/logout}"
	method="post"&gt;
&lt;input type="submit"
	value="Log out" /&gt;
&lt;input type="hidden"
	th:name="${_csrf.parameterName}"
	th:value="${_csrf.token}"/&gt;
&lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="webflux-csrf-include-ajax"><a class="anchor" href="#webflux-csrf-include-ajax"></a>Ajax and JSON Requests</h5>
<div class="paragraph">
<p>If you are using JSON, then it is not possible to submit the CSRF token within an HTTP parameter.
Instead you can submit the token within a HTTP header.</p>
</div>
<div class="paragraph">
<p>In the following sections we will discuss various ways of including the CSRF token as an HTTP request header in JavaScript based applications.</p>
</div>
<div class="sect5">
<h6 id="webflux-csrf-include-ajax-auto"><a class="anchor" href="#webflux-csrf-include-ajax-auto"></a>Automatic Inclusion</h6>
<div class="paragraph">
<p>Spring Security can easily be <a href="#webflux-csrf-configure-custom-repository">configured</a> to store the expected CSRF token in a cookie.
By storing the expected CSRF in a cookie, JavaScript frameworks like <a href="https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection">AngularJS</a> will automatically include the actual CSRF token in the HTTP request headers.</p>
</div>
</div>
<div class="sect5">
<h6 id="webflux-csrf-include-ajax-meta"><a class="anchor" href="#webflux-csrf-include-ajax-meta"></a>Meta tags</h6>
<div class="paragraph">
<p>An alternative pattern to <a href="#webflux-csrf-include-form-auto">exposing the CSRF in a cookie</a> is to include the CSRF token within your <code>meta</code> tags.
The HTML might look something like this:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. CSRF meta tag HTML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;html&gt;
&lt;head&gt;
	&lt;meta name="_csrf" content="4bfd1575-3ad1-4d21-96c7-4ef2d9f86721"/&gt;
	&lt;meta name="_csrf_header" content="X-CSRF-TOKEN"/&gt;
	&lt;!-- ... --&gt;
&lt;/head&gt;
&lt;!-- ... --&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the meta tags contained the CSRF token, the JavaScript code would read the meta tags and include the CSRF token as a header.
If you were using jQuery, this could be done with the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. AJAX send CSRF Token</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">$(function () {
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	$(document).ajaxSend(function(e, xhr, options) {
		xhr.setRequestHeader(header, token);
	});
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The sample below assumes that you <a href="#webflux-csrf-include-subscribe">expose</a> the <code>CsrfToken</code> on an attribute named <code>_csrf</code>.
An example of doing this with Thymeleaf is shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. CSRF meta tag JSP</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;html&gt;
&lt;head&gt;
	&lt;meta name="_csrf" th:content="${_csrf.token}"/&gt;
	&lt;!-- default header name is X-CSRF-TOKEN --&gt;
	&lt;meta name="_csrf_header" th:content="${_csrf.headerName}"/&gt;
	&lt;!-- ... --&gt;
&lt;/head&gt;
&lt;!-- ... --&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-csrf-considerations"><a class="anchor" href="#webflux-csrf-considerations"></a>CSRF Considerations</h3>
<div class="paragraph">
<p>There are a few special considerations to consider when implementing protection against CSRF attacks.
This section discusses those considerations as it pertains to WebFlux environments.
Refer to <a href="#csrf-considerations">[csrf-considerations]</a> for a more general discussion.</p>
</div>
<div class="sect3">
<h4 id="webflux-considerations-csrf-login"><a class="anchor" href="#webflux-considerations-csrf-login"></a>Logging In</h4>
<div class="paragraph">
<p>It is important to <a href="#csrf-considerations-login">require CSRF for log in</a> requests to protect against forging log in attempts.
Spring Security&#8217;s WebFlux support does this out of the box.</p>
</div>
</div>
<div class="sect3">
<h4 id="webflux-considerations-csrf-logout"><a class="anchor" href="#webflux-considerations-csrf-logout"></a>Logging Out</h4>
<div class="paragraph">
<p>It is important to <a href="#csrf-considerations-logout">require CSRF for log out</a> requests to protect against forging log out attempts.
By default Spring Security&#8217;s <code>LogoutWebFilter</code> only processes HTTP post requests.
This ensures that log out requires a CSRF token and that a malicious user cannot forcibly log out your users.</p>
</div>
<div class="paragraph">
<p>The easiest approach is to use a form to log out.
If you really want a link, you can use JavaScript to have the link perform a POST (i.e. maybe on a hidden form).
For browsers with JavaScript that is disabled, you can optionally have the link take the user to a log out confirmation page that will perform the POST.</p>
</div>
<div class="paragraph">
<p>If you really want to use HTTP GET with logout you can do so, but remember this is generally not recommended.
For example, the following Java Configuration will perform logout with the URL <code>/logout</code> is requested with any HTTP method:</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Log out with HTTP GET</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.logout(logout -&gt; logout.requiresLogout(new PathPatternParserServerWebExchangeMatcher("/logout")))
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        logout {
            requiresLogout = PathPatternParserServerWebExchangeMatcher("/logout")
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="webflux-considerations-csrf-timeouts"><a class="anchor" href="#webflux-considerations-csrf-timeouts"></a>CSRF and Session Timeouts</h4>
<div class="paragraph">
<p>By default Spring Security stores the CSRF token in the <code>WebSession</code>.
This can lead to a situation where the session expires which means there is not an expected CSRF token to validate against.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already discussed <a href="#csrf-considerations-login">general solutions</a> to session timeouts.
This section discusses the specifics of CSRF timeouts as it pertains to the WebFlux support.</p>
</div>
<div class="paragraph">
<p>It is simple to change storage of the expected CSRF token to be in a cookie.
For details, refer to the <a href="#webflux-csrf-configure-custom-repository">Custom CsrfTokenRepository</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="webflux-csrf-considerations-multipart"><a class="anchor" href="#webflux-csrf-considerations-multipart"></a>Multipart (file upload)</h4>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart">already discussed</a> how protecting multipart requests (file uploads) from CSRF attacks causes a <a href="https://en.wikipedia.org/wiki/Chicken_or_the_egg">chicken and the egg</a> problem.
This section discusses how to implement placing the CSRF token in the <a href="#webflux-csrf-considerations-multipart-body">body</a> and <a href="#webflux-csrf-considerations-multipart-url">url</a> within a WebFlux application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>More information about using multipart forms with Spring can be found within the <a href="https://docs.spring.io/spring/docs/5.2.x/spring-framework-reference/web-reactive.html#webflux-multipart">Multipart Data</a> section of the Spring reference.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="webflux-csrf-considerations-multipart-body"><a class="anchor" href="#webflux-csrf-considerations-multipart-body"></a>Place CSRF Token in the Body</h5>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart">already discussed</a> the trade-offs of placing the CSRF token in the body.</p>
</div>
<div class="paragraph">
<p>In a WebFlux application, this can be configured with the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Enable obtaining CSRF token from multipart/form-data</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.csrf(csrf -&gt; csrf.tokenFromMultipartDataEnabled(true))
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
		// ...
        csrf {
            tokenFromMultipartDataEnabled = true
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="webflux-csrf-considerations-multipart-url"><a class="anchor" href="#webflux-csrf-considerations-multipart-url"></a>Include CSRF Token in URL</h5>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-multipart">already discussed</a> the trade-offs of placing the CSRF token in the URL.
Since the <code>CsrfToken</code> is exposed as an <code>ServerHttpRequest</code> <a href="#webflux-csrf-include">request attribute</a>, we can use that to create an <code>action</code> with the CSRF token in it.
An example with Thymeleaf is shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. CSRF Token in Action</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;form method="post"
	th:action="@{/upload(${_csrf.parameterName}=${_csrf.token})}"
	enctype="multipart/form-data"&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="webflux-csrf-considerations-override-method"><a class="anchor" href="#webflux-csrf-considerations-override-method"></a>HiddenHttpMethodFilter</h4>
<div class="paragraph">
<p>We have <a href="#csrf-considerations-override-method">already discussed</a> overriding the HTTP method.</p>
</div>
<div class="paragraph">
<p>In a Spring WebFlux application, overriding the HTTP method is done using <a href="https://docs.spring.io/spring-framework/docs/5.2.x/javadoc-api/org/springframework/web/filter/reactive/HiddenHttpMethodFilter.html">HiddenHttpMethodFilter</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="webflux-headers"><a class="anchor" href="#webflux-headers"></a>Security HTTP Response Headers</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#headers">Security HTTP Response Headers</a> can be used to increase the security of web applications.
This section is dedicated to WebFlux based support for Security HTTP Response Headers.</p>
</div>
<div class="sect2">
<h3 id="webflux-headers-default"><a class="anchor" href="#webflux-headers-default"></a>Default Security Headers</h3>
<div class="paragraph">
<p>Spring Security provides a <a href="#headers-default">default set of Security HTTP Response Headers</a> to provide secure defaults.
While each of these headers are considered best practice, it should be noted that not all clients utilize the headers, so additional testing is encouraged.</p>
</div>
<div class="paragraph">
<p>You can customize specific headers.
For example, assume that you want the defaults except you wish to specify <code>SAMEORIGIN</code> for <a href="#servlet-headers-frame-options">X-Frame-Options</a>.</p>
</div>
<div class="paragraph">
<p>You can easily do this with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Customize Default Security Headers</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.frameOptions(frameOptions -&gt; frameOptions
				.mode(Mode.SAMEORIGIN)
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            frameOptions {
                mode = Mode.SAMEORIGIN
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you do not want the defaults to be added and want explicit control over what should be used, you can disable the defaults.
An example is provided below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Disable HTTP Security Response Headers</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers.disable());
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            disable()
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-cache-control"><a class="anchor" href="#webflux-headers-cache-control"></a>Cache Control</h3>
<div class="paragraph">
<p>Spring Security includes <a href="#headers-cache-control">Cache Control</a> headers by default.</p>
</div>
<div class="paragraph">
<p>However, if you actually want to cache specific responses, your application can selectively add them to the <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/server/reactive/ServerHttpResponse.html">ServerHttpResponse</a> to override the header set by Spring Security.
This is useful to ensure things like CSS, JavaScript, and images are properly cached.</p>
</div>
<div class="paragraph">
<p>When using Spring WebFluxZz, this is typically done within your configuration.
Details on how to do this can be found in the <a href="https://docs.spring.io/spring/docs/5.0.0.RELEASE/spring-framework-reference/web-reactive.html#webflux-config-static-resources">Static Resources</a> portion of the Spring Reference documentation</p>
</div>
<div class="paragraph">
<p>If necessary, you can also disable Spring Security&#8217;s cache control HTTP response headers.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Cache Control Disabled</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.cache(cache -&gt; cache.disable())
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            cache {
                disable()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-content-type-options"><a class="anchor" href="#webflux-headers-content-type-options"></a>Content Type Options</h3>
<div class="paragraph">
<p>Spring Security includes <a href="#headers-content-type-options">Content-Type</a> headers by default.
However, you can disable it with:</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Content Type Options Disabled</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.contentTypeOptions(contentTypeOptions -&gt; contentTypeOptions.disable())
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            contentTypeOptions {
                disable()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-hsts"><a class="anchor" href="#webflux-headers-hsts"></a>HTTP Strict Transport Security (HSTS)</h3>
<div class="paragraph">
<p>Spring Security provides the <a href="#headers-hsts">Strict Transport Security</a> header by default.
However, you can customize the results explicitly.
For example, the following is an example of explicitly providing HSTS:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Strict Transport Security</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.hsts(hsts -&gt; hsts
				.includeSubdomains(true)
				.preload(true)
				.maxAge(Duration.ofDays(365))
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            hsts {
                includeSubdomains = true
                preload = true
                maxAge = Duration.ofDays(365)
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-frame-options"><a class="anchor" href="#webflux-headers-frame-options"></a>X-Frame-Options</h3>
<div class="paragraph">
<p>By default, Spring Security disables rendering within an iframe using <a href="#headers-frame-options">X-Frame-Options</a>.</p>
</div>
<div class="paragraph">
<p>You can customize frame options to use the same origin using the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. X-Frame-Options: SAMEORIGIN</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.frameOptions(frameOptions -&gt; frameOptions
				.mode(SAMEORIGIN)
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            frameOptions {
                mode = SAMEORIGIN
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-xss-protection"><a class="anchor" href="#webflux-headers-xss-protection"></a>X-XSS-Protection</h3>
<div class="paragraph">
<p>By default, Spring Security instructs browsers to block reflected XSS attacks using the &lt;&lt;headers-xss-protection,X-XSS-Protection header&gt;.
You can disable <code>X-XSS-Protection</code> with the following Configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. X-XSS-Protection Customization</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.xssProtection(xssProtection -&gt; xssProtection.disable())
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            xssProtection {
                disable()
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-csp"><a class="anchor" href="#webflux-headers-csp"></a>Content Security Policy (CSP)</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-csp">Content Security Policy</a> by default, because a reasonable default is impossible to know without context of the application.
The web application author must declare the security policy(s) to enforce and/or monitor for the protected resources.</p>
</div>
<div class="paragraph">
<p>For example, given the following security policy:</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Content Security Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-http hljs" data-lang="http">Content-Security-Policy: script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can enable the CSP header as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Content Security Policy</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.contentSecurityPolicy(policy -&gt; policy
				.policyDirectives("script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/")
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            contentSecurityPolicy {
                policyDirectives = "script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To enable the CSP <code>report-only</code> header, provide the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Content Security Policy Report Only</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.contentSecurityPolicy(policy -&gt; policy
				.policyDirectives("script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/")
				.reportOnly()
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            contentSecurityPolicy {
                policyDirectives = "script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"
                reportOnly = true
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-referrer"><a class="anchor" href="#webflux-headers-referrer"></a>Referrer Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-referrer">Referrer Policy</a> headers by default.
You can enable the Referrer Policy header using configuration as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Referrer Policy Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.referrerPolicy(referrer -&gt; referrer
				.policy(ReferrerPolicy.SAME_ORIGIN)
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            referrerPolicy {
                policy = ReferrerPolicy.SAME_ORIGIN
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-feature"><a class="anchor" href="#webflux-headers-feature"></a>Feature Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-feature">Feature Policy</a> headers by default.
The following <code>Feature-Policy</code> header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Feature-Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Feature-Policy: geolocation 'self'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can enable the Feature Policy header as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Feature-Policy Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.featurePolicy("geolocation 'self'")
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            featurePolicy("geolocation 'self'")
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-permissions"><a class="anchor" href="#webflux-headers-permissions"></a>Permissions Policy</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-permissions">Permissions Policy</a> headers by default.
The following <code>Permissions-Policy</code> header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Permissions-Policy Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Permissions-Policy: geolocation=(self)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can enable the Permissions Policy header as shown below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Permissions-Policy Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.headers(headers -&gt; headers
			.permissionsPolicy(permissions -&gt; permissions
				.policy("geolocation=(self)")
			)
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        headers {
            permissionsPolicy {
                policy = "geolocation=(self)"
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-headers-clear-site-data"><a class="anchor" href="#webflux-headers-clear-site-data"></a>Clear Site Data</h3>
<div class="paragraph">
<p>Spring Security does not add <a href="#headers-clear-site-data">Clear-Site-Data</a> headers by default.
The following Clear-Site-Data header:</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Clear-Site-Data Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>Clear-Site-Data: "cache", "cookies"</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>can be sent on log out with the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Clear-Site-Data Configuration</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	ServerLogoutHandler securityContext = new SecurityContextServerLogoutHandler();
	ClearSiteDataServerHttpHeadersWriter writer = new ClearSiteDataServerHttpHeadersWriter(CACHE, COOKIES);
	ServerLogoutHandler clearSiteData = new HeaderWriterServerLogoutHandler(writer);
	DelegatingServerLogoutHandler logoutHandler = new DelegatingServerLogoutHandler(securityContext, clearSiteData);

	http
		// ...
		.logout()
			.logoutHandler(logoutHandler);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun webFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    val securityContext: ServerLogoutHandler = SecurityContextServerLogoutHandler()
    val writer = ClearSiteDataServerHttpHeadersWriter(CACHE, COOKIES)
    val clearSiteData: ServerLogoutHandler = HeaderWriterServerLogoutHandler(writer)
    val customLogoutHandler = DelegatingServerLogoutHandler(securityContext, clearSiteData)

    return http {
        // ...
        logout {
            logoutHandler = customLogoutHandler
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="webflux-http"><a class="anchor" href="#webflux-http"></a>HTTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All HTTP based communication should be protected <a href="#http">using TLS</a>.</p>
</div>
<div class="paragraph">
<p>Below you can find details around WebFlux specific features that assist with HTTPS usage.</p>
</div>
<div class="sect2">
<h3 id="webflux-http-redirect"><a class="anchor" href="#webflux-http-redirect"></a>Redirect to HTTPS</h3>
<div class="paragraph">
<p>If a client makes a request using HTTP rather than HTTPS, Spring Security can be configured to redirect to HTTPS.</p>
</div>
<div class="paragraph">
<p>For example, the following Java configuration will redirect any HTTP requests to HTTPS:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Redirect to HTTPS</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.redirectToHttps(withDefaults());
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        redirectToHttps { }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The configuration can easily be wrapped around an if statement to only be turned on in production.
Alternatively, it can be enabled by looking for a property about the request that only happens in production.
For example, if the production environment adds a header named <code>X-Forwarded-Proto</code> the following Java Configuration could be used:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Redirect to HTTPS when X-Forwarded</div>
<div class="content">
<div class="listingblock primary">
<div class="title">Java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	http
		// ...
		.redirectToHttps(redirect -&gt; redirect
			.httpsRedirectWhen(e -&gt; e.getRequest().getHeaders().containsKey("X-Forwarded-Proto"))
		);
	return http.build();
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Kotlin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@Bean
fun springSecurityFilterChain(http: ServerHttpSecurity): SecurityWebFilterChain {
    return http {
        // ...
        redirectToHttps {
            httpsRedirectWhen {
                it.request.headers.containsKey("X-Forwarded-Proto")
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="webflux-hsts"><a class="anchor" href="#webflux-hsts"></a>Strict Transport Security</h3>
<div class="paragraph">
<p>Spring Security provides support for <a href="#servlet-headers-hsts">Strict Transport Security</a> and enables it by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="webflux-http-proxy-server"><a class="anchor" href="#webflux-http-proxy-server"></a>Proxy Server Configuration</h3>
<div class="paragraph">
<p>Spring Security <a href="#http-proxy-server">integrates with proxy servers</a>.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/tabs.js"></script>
<script src="../../../../_/js/vendor/docsearch.min.js"></script>
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js -->
<script>
docsearch({
  appId: 'L0TI0XV6RD',
  apiKey: '278da59d0706716556405ce7a28ba297',
  indexName: 'dev_spring',
  inputSelector: '#search-input',
  algoliaOptions: { hitsPerPage: 10 }
})
</script>  </body>
</html>
